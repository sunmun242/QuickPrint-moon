<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickPrint - Automated EPSON Print Service</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@2.14.305/build/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.14.305/build/pdf.worker.min.js';
    </script>
</head>
<body>


    <header class="top-bar">
        <div class="header-content">
            <h1 class="logo">QuickPrint</h1>
        </div>
    </header>
    
    <div class="container">
        <div class="step-section active" id="step1">
            <h2 class="step-header">1. Upload Your Document (PDF, JPG, PNG)</h2>
            <form id="uploadForm" enctype="multipart/form-data">
                <input type="file" id="fileToPrint" name="fileToPrint" accept=".pdf,.jpg,.jpeg,.png" required>
                <button type="submit" class="primary-button" id="uploadButton">Upload & Analyze</button>
            </form>
            <p class="small-text">Your file will be securely uploaded and deleted after printing.</p>
        </div>


        <div class="step-section" id="step2" style="display: none;">
            <h2 class="step-header">2. Check Preview & Set Options</h2>
            
            <div class="options-and-preview-grid">
                
                <div class="options-column">
                    <div class="summary-box">
                        <h3>File Summary:</h3>
                        <p><strong>File Name:</strong> <span id="summaryFileName"></span></p>
                        <p><strong>Total Pages:</strong> <span id="summaryPageCount"></span></p>
                        <p><strong>Paper Size:</strong> A4 (Default)</p>
                    </div>


                    <div class="config-box">
                        <h3>Printing Configuration:</h3>
                        <div class="input-group">
                            <label for="copies">Copies:</label>
                            <input type="number" id="copies" value="1" min="1">
                        </div>
                        <div class="input-group">
                            <label for="printType">Color Mode:</label>
                            <select id="printType">
                                <option value="bw">Black & White (₹2.00/page)</option>
                                <option value="color">Colour (₹4.00/page)</option>
                            </select>
                        </div>
                    </div>


                    <div class="cost-summary-box">
                        <h3>Estimated Cost:</h3>
                        <p>Total Print Cost: ₹<span id="totalCostDisplay">0.00</span></p>
                        <button type="button" class="primary-button" id="proceedButton">Proceed to Payment</button>
                    </div>
                </div>


                <div class="preview-column">
                    <h3>Document Preview (Page 1)</h3>
                    <div id="filePreview" class="preview-area">
                        <canvas id="pdfViewer" style="max-width: 100%; border: 1px solid #ccc;"></canvas>
                        <img id="imageViewer" style="max-width: 100%; border: 1px solid #ccc; display: none;">
                        <p id="previewMessage" style="text-align: center; margin-top: 10px; color: #555;">Preview of the first page will appear here.</p>
                    </div>
                </div>


            </div>
        </div>
    </div>


    <footer>
        <div class="footer-content">
            <p>&copy; 2025 QuickPrint. All rights reserved.</p>
            <div class="footer-links">
                <a href="/about">About Us</a>
                <a href="https://wa.me/917063312134" target="_blank">Contact Us (WhatsApp)</a>
            </div>
        </div>
    </footer>


    <script>
        // Set fixed prices
        const PRICE_BW = 2.00; // Fixed price
        const PRICE_COLOR = 4.00; // Fixed price
        let globalPrintData = {}; // To store upload data


        // --- Preview Function ---


        function showPdfPreview(fileUrl) {
            const canvas = document.getElementById('pdfViewer');
            const imageViewer = document.getElementById('imageViewer');
            imageViewer.style.display = 'none';
            canvas.style.display = 'block';


            pdfjsLib.getDocument(fileUrl).promise.then(function(pdfDoc) {
                pdfDoc.getPage(1).then(function(page) {
                    const viewport = page.getViewport({ scale: 1.5 });
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    const renderContext = {
                        canvasContext: canvas.getContext('2d'),
                        viewport: viewport
                    };
                    page.render(renderContext);
                    document.getElementById('previewMessage').style.display = 'none';
                });
            }).catch(function(error) {
                console.error("PDF Preview Error:", error);
                document.getElementById('previewMessage').textContent = "Could not render PDF preview.";
                canvas.style.display = 'none';
            });
        }


        function showImagePreview(fileUrl) {
            const canvas = document.getElementById('pdfViewer');
            const imageViewer = document.getElementById('imageViewer');
            canvas.style.display = 'none';
            imageViewer.style.display = 'block';
            imageViewer.src = fileUrl;
            document.getElementById('previewMessage').style.display = 'none';
        }


        // --- Cost Calculation Function ---


        function calculateCost() {
            const copies = parseInt(document.getElementById('copies').value) || 1;
            const printType = document.getElementById('printType').value;
            const pageCount = globalPrintData.page_count || 1;


            const rate = (printType === 'bw' ? PRICE_BW : PRICE_COLOR);
            const totalCost = rate * pageCount * copies;
            
            document.getElementById('totalCostDisplay').textContent = totalCost.toFixed(2);
            
            // Save data
            globalPrintData.copies = copies;
            globalPrintData.printType = printType;
            globalPrintData.totalCost = totalCost;
        }




        document.addEventListener('DOMContentLoaded', function() {
            // 1. File Upload Handling
            document.getElementById('uploadForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                document.getElementById('uploadButton').textContent = 'Uploading...';
                document.getElementById('uploadButton').disabled = true;


                fetch('/upload', {
                    method: 'POST',
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('uploadButton').textContent = 'Upload & Analyze';
                    document.getElementById('uploadButton').disabled = false;
                    
                    if (data.success) {
                        globalPrintData = data;
                        
                        // 2. UI Update
                        document.getElementById('summaryFileName').textContent = data.filename;
                        document.getElementById('summaryPageCount').textContent = data.page_count;
                        
                        // 3. Show Preview
                        const fileExtension = data.filename.split('.').pop().toLowerCase();
                        if (fileExtension === 'pdf') {
                            showPdfPreview(data.file_url);
                        } else if (['jpg', 'jpeg', 'png'].includes(fileExtension)) {
                            showImagePreview(data.file_url);
                        }
                        
                        // 4. Calculate cost and move to step 2
                        calculateCost();
                        document.getElementById('step1').style.display = 'none';
                        document.getElementById('step2').style.display = 'block';
                    } else {
                        alert('Upload failed: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('uploadButton').textContent = 'Upload & Analyze';
                    document.getElementById('uploadButton').disabled = false;
                    alert('An error occurred during upload.');
                });
            });


            // 5. Recalculate cost when options change
            document.getElementById('copies').addEventListener('input', calculateCost);
            document.getElementById('printType').addEventListener('change', calculateCost);




            // 6. Proceed to Payment step
            document.getElementById('proceedButton').addEventListener('click', function() {
                if (globalPrintData.totalCost > 0) {
                    localStorage.setItem('printData', JSON.stringify(globalPrintData));
                    window.location.href = '/payment';
                } else {
                    alert("Please set print options.");
                }
            });
        });
    </script>
</body>
</html>




